name: React Compatibility Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  test-matrix:
    name: Test React ${{ matrix.react-version }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        react-version:
          - '18.3.1'  # Current stable (LTS)
          - '19.0.0'  # Latest major version
        node-version:
          - '20'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install React ${{ matrix.react-version }}
        run: |
          echo "Testing with React ${{ matrix.react-version }}"
          npm install --save-peer react@${{ matrix.react-version }} react-dom@${{ matrix.react-version }}
      
      - name: Show installed versions
        run: |
          echo "React version:"
          npm list react
          echo "React DOM version:"
          npm list react-dom
      
      - name: Run tests
        run: npm test -- --coverage
        env:
          CI: true
      
      - name: Run build
        run: npm run build
      
      - name: Upload coverage (React 18 only)
        if: matrix.react-version == '18.3.1'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-react-18
          path: coverage/
          retention-days: 30
      
      - name: Upload coverage (React 19)
        if: matrix.react-version == '19.0.0'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-react-19
          path: coverage/
          retention-days: 30
      
      - name: Test summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Tests passed with React ${{ matrix.react-version }}"
          else
            echo "❌ Tests failed with React ${{ matrix.react-version }}"
          fi

  compatibility-report:
    name: Generate Compatibility Report
    runs-on: ubuntu-latest
    needs: test-matrix
    if: always()
    
    steps:
      - name: Create compatibility report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Get workflow run details
            const { data: workflowRun } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });
            
            // Get jobs for this workflow run
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });
            
            // Generate report
            let report = `## React Compatibility Test Results\n\n`;
            report += `**Workflow:** ${workflowRun.name}\n`;
            report += `**Trigger:** ${workflowRun.event}\n`;
            report += `**Date:** ${new Date().toISOString()}\n\n`;
            report += `### Test Matrix Results\n\n`;
            report += `| React Version | Node Version | Status |\n`;
            report += `|---------------|--------------|--------|\n`;
            
            for (const job of jobs.jobs) {
              if (job.name.startsWith('Test React')) {
                const match = job.name.match(/Test React ([\d.]+)/);
                const reactVersion = match ? match[1] : 'Unknown';
                const status = job.conclusion === 'success' ? '✅ Pass' : '❌ Fail';
                report += `| ${reactVersion} | 20 | ${status} |\n`;
              }
            }
            
            report += `\n### Summary\n\n`;
            const allPassed = jobs.jobs
              .filter(j => j.name.startsWith('Test React'))
              .every(j => j.conclusion === 'success');
            
            if (allPassed) {
              report += `✅ **All React versions are compatible!**\n\n`;
              report += `The package works correctly with both React 18 and React 19.\n`;
            } else {
              report += `⚠️ **Some compatibility issues detected**\n\n`;
              report += `Please review the failed jobs for details.\n`;
            }
            
            console.log(report);
            
            // For PR comments
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }

  update-compatibility-badge:
    name: Update Compatibility Status
    runs-on: ubuntu-latest
    needs: test-matrix
    if: github.ref == 'refs/heads/main' && always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate compatibility status
        id: compat-status
        run: |
          if [ "${{ needs.test-matrix.result }}" == "success" ]; then
            echo "status=compatible" >> $GITHUB_OUTPUT
            echo "color=brightgreen" >> $GITHUB_OUTPUT
            echo "message=React 18 & 19" >> $GITHUB_OUTPUT
          else
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "color=yellow" >> $GITHUB_OUTPUT
            echo "message=React 18 only" >> $GITHUB_OUTPUT
          fi
      
      - name: Create compatibility badge data
        run: |
          mkdir -p .github/badges
          cat > .github/badges/react-compat.json << EOF
          {
            "schemaVersion": 1,
            "label": "React Compatibility",
            "message": "${{ steps.compat-status.outputs.message }}",
            "color": "${{ steps.compat-status.outputs.color }}"
          }
          EOF
      
      - name: Commit badge data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .github/badges/react-compat.json
          git diff --quiet && git diff --staged --quiet || git commit -m "chore: update React compatibility badge [skip ci]"
          git push
