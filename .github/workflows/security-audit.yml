name: Security Audit

on:
  # Run on every push to main and PRs
  push:
    branches: [main]
  pull_request:
    branches: [main]
  
  # Run weekly security audits
  schedule:
    # Every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  security-audit:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate
        continue-on-error: true
        id: npm-audit
      
      - name: Run npm audit (JSON output for reporting)
        run: |
          echo "Generating detailed audit report..."
          npm audit --json > audit-report.json
        continue-on-error: true
      
      - name: Check for high/critical vulnerabilities
        run: |
          echo "Checking for high/critical severity vulnerabilities..."
          HIGH_COUNT=$(npm audit --json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_COUNT=$(npm audit --json | jq '.metadata.vulnerabilities.critical // 0')
          
          echo "High severity: $HIGH_COUNT"
          echo "Critical severity: $CRITICAL_COUNT"
          
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "âŒ CRITICAL vulnerabilities found! Failing build."
            npm audit --audit-level=critical
            exit 1
          fi
          
          if [ "$HIGH_COUNT" -gt 0 ]; then
            echo "âš ï¸  HIGH severity vulnerabilities found!"
            npm audit --audit-level=high
            exit 1
          fi
          
          echo "âœ… No high or critical vulnerabilities found."
      
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: security-audit-report
          path: audit-report.json
          retention-days: 90
      
      - name: Audit summary comment (PR only)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let auditData;
            
            try {
              auditData = JSON.parse(fs.readFileSync('audit-report.json', 'utf8'));
            } catch (error) {
              console.log('Could not read audit report');
              return;
            }
            
            const metadata = auditData.metadata || {};
            const vulnerabilities = metadata.vulnerabilities || {};
            
            const total = vulnerabilities.total || 0;
            const critical = vulnerabilities.critical || 0;
            const high = vulnerabilities.high || 0;
            const moderate = vulnerabilities.moderate || 0;
            const low = vulnerabilities.low || 0;
            
            let emoji = 'âœ…';
            let status = 'PASSED';
            
            if (critical > 0 || high > 0) {
              emoji = 'âŒ';
              status = 'FAILED';
            } else if (moderate > 0) {
              emoji = 'âš ï¸';
              status = 'WARNING';
            }
            
            const comment = `## ${emoji} Security Audit ${status}
            
            **Vulnerability Summary:**
            - ðŸ”´ Critical: ${critical}
            - ðŸŸ  High: ${high}
            - ðŸŸ¡ Moderate: ${moderate}
            - ðŸŸ¢ Low: ${low}
            - **Total:** ${total}
            
            ${critical > 0 || high > 0 ? 'âš ï¸ **Action Required:** Please address high/critical vulnerabilities before merging.' : ''}
            ${moderate > 0 ? 'ðŸ“‹ **Review Recommended:** Moderate vulnerabilities detected.' : ''}
            ${total === 0 ? 'ðŸŽ‰ **All Clear:** No known vulnerabilities detected!' : ''}
            
            ---
            *Audit performed by [npm audit](https://docs.npmjs.com/cli/v8/commands/npm-audit)*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  dependency-review:
    name: Dependency Review (PR Only)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          # Fail on critical and high severity vulnerabilities
          fail-on-severity: high
          
          # Show warnings for moderate
          warn-on-severity: moderate
          
          # Comment on PR with results
          comment-summary-in-pr: always
          
          # Deny licenses (customize as needed)
          deny-licenses: GPL-2.0, GPL-3.0
          
          # Allow licenses
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript
          queries: security-and-quality
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"
